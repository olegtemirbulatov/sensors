<!DOCTYPE html>
<html>
    <head>
        <title>Sensors list</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <script scr="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <style>
            #container {
                margin: 0px auto;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="container" class="container-fluid">
            <h3>Sensors list</h3>
            <button onclick="addNewRow()" class="btn btn-primary">Add new sensor</button>
            <br>
            <br>
            <table id="sensors-table" class="table table-bordered table-striped">
                <tr>
                    <th>User name</th>
                    <th>Sensor name</th>
                    <th>Action</th>
                </tr>

                {% for sensor in sensors_list %}
                <tr>
                    <td id="user">{{ sensor.user }}</td>
                    <td id="sensor">{{ sensor.name }}</td>
                    <td>
                        <input class="btn btn-danger" type="button" value="Delete" onclick="deleteRow(this)" />
                        <input class="btn btn-success" type="button" value="Details" onclick="watchDetails()" />
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </body>

    <script src="https://yastatic.net/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript">

        function addNewRow() {
            var table = document.getElementById("sensors-table");
            var rowCount = table.rows.length;
            var cellCount = table.rows[0].cells.length;
            var row = table.insertRow(rowCount);
            for (var i = 0; i < cellCount; i++) {
                var cell = row.insertCell(i);
                if (i < cellCount-1) {
                    cell.innerHTML = '<input type="text" class="form-control" />';
                }
                else {
                    cell.innerHTML = '<input class="btn btn-danger" '
                    + ' type="button" value="Delete" onclick="deleteRow(this)" />'
                    + ' <input class="btn btn-success" type="button" value="Save" onclick="saveNewData(this)" />'
                }
            }
        }
        
        function getElementsByValue(row, index, value) {
            /*
            не работает, если добавили новую строку с кнопкой "Save"!!!
            */
            var tr = document.querySelectorAll('tr');
            var button = tr[index].querySelectorAll('input');
            console.log('button value = ', button[1].getAttribute('value'));
            var attr = button[1].getAttribute('value');
            if (attr == value) {
                return true;
            }
            return false;
        }

        function deleteRow(ele) {
            var table = document.getElementById("sensors-table");
            var rowCount = table.rows.length;
            var row = ele.parentNode.parentNode;
            console.log('rowIndex = ', row.rowIndex);
            /*
            if (rowCount <= 1) {
                alert("There is no sensor to delete!");
                return;
            }
            */
            if (ele) {
                // delete specifc row
                console.log('if Save button in row: ', getElementsByValue(row, row.rowIndex, "Save"));
                if (getElementsByValue(row, row.rowIndex, "Save") == false) {
                    var tr = document.querySelectorAll('tr');
                    var needtr = tr[row.rowIndex].querySelectorAll('td');
                    var objectData =
                    {
                        User: needtr[0].innerHTML,
                        Name: needtr[1].innerHTML
                    };
                    //var objectDataString = JSON.stringify(objectData);
                    console.log('object: ', objectData);

                    $.ajax({
                        type: "POST",
                        url: "http://127.0.0.1:8000/sensorslist/delete_data/", //add new url for each of the activity,
                        dataType: "json",
                        data: objectData,
                        success: function (data) {
                            console.log('success!');
                        },
                        error: function (data) {
                            console.log('error');
                        }
                    });
                }
                row.parentNode.removeChild(row);
            }
        }

        function saveNewData() {
            var table = document.getElementById('sensors-table');
            var row = 0;
        }

    </script>
</html>